<div class="min-h-screen bg-gray-50 pt-20">
  <div class="max-w-6xl mx-auto px-6 py-6">
    <!-- Loading -->
    <div *ngIf="loading" class="flex items-center justify-center h-48">
      <i class="pi pi-spin pi-spinner text-4xl text-blue-500"></i>
    </div>

    <!-- Message si pas de provider -->
    <div *ngIf="!loading && !provider" class="text-center py-12">
      <i class="pi pi-exclamation-triangle text-5xl text-red-500 mb-4"></i>
      <p class="text-xl text-gray-700">Prestataire introuvable</p>
      <button
        pButton
        label="Retour"
        icon="pi pi-arrow-left"
        class="p-button-outlined mt-4"
        (click)="back()"
      ></button>
    </div>

    <!-- Contenu -->
    <div *ngIf="!loading && provider" class="space-y-6">
      <!-- En-t√™te -->
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <div
          class="flex flex-col md:flex-row items-start justify-between gap-4"
        >
          <div class="flex items-center gap-4">
            <!-- Photo avec badge v√©rifi√© -->
            <div class="relative">
              <img
                [src]="provider.photo || 'assets/avatar-default.png'"
                alt="photo"
                class="w-24 h-24 rounded-full object-cover border-2 border-gray-200 shadow-sm"
              />
              <!-- ‚úÖ BADGE V√âRIFI√â -->
              <div
                *ngIf="provider.statut === 'actif'"
                class="absolute -bottom-1 -right-1 bg-green-500 rounded-full p-1.5 border-2 border-white shadow-lg"
                pTooltip="Compte v√©rifi√©"
                tooltipPosition="top"
              >
                <i class="pi pi-check text-white text-sm font-bold"></i>
              </div>
            </div>

            <div>
              <div class="flex items-center gap-2">
                <h2 class="text-2xl font-bold text-gray-900">
                  {{ provider.prenom }} {{ provider.nom }}
                </h2>
                <!-- ‚úÖ BADGE V√âRIFI√â TEXTE (optionnel) -->
                <span
                  *ngIf="provider.statut === 'actif'"
                  class="inline-flex items-center gap-1 px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs font-medium"
                >
                  <i class="pi pi-verified"></i>
                  V√©rifi√©
                </span>
              </div>

              <p class="text-sm text-gray-500 mt-1">
                {{ provider.metier }} ‚Ä¢ {{ provider.ville }}
              </p>

              <div class="mt-2 flex items-center gap-2">
                <p-tag
                  [value]="displayStatut(provider.statut)"
                  [severity]="getStatutSeverity(provider.statut)"
                ></p-tag>
              </div>

              <div class="mt-2 text-sm text-gray-600">
                <span class="font-semibold">{{ provider.email }}</span>
                <span class="mx-2">‚Ä¢</span>
                <span>{{ provider.telephone }}</span>
              </div>
            </div>
          </div>

          <div class="flex flex-wrap items-start gap-2">
            <button
              pButton
              icon="pi pi-arrow-left"
              class="p-button-outlined"
              pTooltip="Retour"
              tooltipPosition="bottom"
              (click)="back()"
            ></button>
            <button
              pButton
              label="Valider"
              icon="pi pi-check"
              class="p-button-success"
              (click)="validateProvider()"
              *ngIf="provider.statut !== 'actif'"
            ></button>
            <button
              pButton
              label="Refuser"
              icon="pi pi-times"
              class="p-button-danger p-button-outlined"
              (click)="openRejectDialog()"
            ></button>
            <button
              pButton
              icon="pi pi-trash"
              class="p-button-danger p-button-text"
              pTooltip="Supprimer"
              tooltipPosition="bottom"
              (click)="deleteProvider()"
            ></button>
          </div>
        </div>
      </div>

      <!-- Tabs -->
      <div
        class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden"
      >
        <!-- ‚úÖ Ajout de #tabView et [(activeIndex)] -->
        <p-tabView
          #tabView
          [(activeIndex)]="activeTabIndex"
          (onChange)="onTabChange($event)"
        >
          <!-- üìã Informations g√©n√©rales -->
          <p-tabPanel header="Informations g√©n√©rales" leftIcon="pi pi-user">
            <div class="p-6 space-y-6">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label class="text-sm font-medium text-gray-700 block mb-1"
                    >M√©tier</label
                  >
                  <p class="text-gray-900">
                    {{ provider.metier || "Non renseign√©" }}
                  </p>
                </div>
                <div>
                  <label class="text-sm font-medium text-gray-700 block mb-1"
                    >Exp√©rience</label
                  >
                  <p class="text-gray-900">
                    <span *ngIf="provider.experience"
                      >{{ provider.experience }} ans</span
                    >
                    <span *ngIf="!provider.experience" class="text-gray-400"
                      >Non renseign√©</span
                    >
                  </p>
                </div>
                <div class="md:col-span-2">
                  <label class="text-sm font-medium text-gray-700 block mb-1"
                    >Description</label
                  >
                  <p class="text-gray-700">
                    <span *ngIf="provider.description">{{
                      provider.description
                    }}</span>
                    <span *ngIf="!provider.description" class="text-gray-400"
                      >Aucune description</span
                    >
                  </p>
                </div>
                <div class="md:col-span-2">
                  <label class="text-sm font-medium text-gray-700 block mb-1"
                    >Adresse</label
                  >
                  <p class="text-gray-700">
                    <i class="pi pi-map-marker mr-2 text-gray-400"></i>
                    {{ provider.adresse?.street || "Non renseign√©" }}
                  </p>
                </div>

                <!-- Certifications -->
                <div
                  class="md:col-span-2"
                  *ngIf="
                    provider.certifications &&
                    provider.certifications.length > 0
                  "
                >
                  <label class="text-sm font-medium text-gray-700 block mb-2"
                    >Certifications</label
                  >
                  <div class="flex flex-wrap gap-2">
                    <span
                      *ngFor="let cert of provider.certifications"
                      class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-blue-100 text-blue-800"
                    >
                      <i class="pi pi-file mr-1"></i>
                      Certification
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </p-tabPanel>

          <!-- üìÑ Documents de v√©rification -->
          <p-tabPanel header="Documents" leftIcon="pi pi-file">
            <div class="p-6 space-y-4">
              <div
                *ngFor="let doc of provider.verificationDocuments"
                class="bg-gray-50 border border-gray-200 rounded-lg p-4"
              >
                <div
                  class="flex flex-col md:flex-row items-start justify-between gap-4"
                >
                  <div class="flex-1 w-full">
                    <div class="flex items-center gap-3 mb-3">
                      <h4 class="font-semibold text-gray-900">
                        {{ getDocumentTypeLabel(doc.documentType) }}
                      </h4>
                      <p-tag
                        [value]="getDocumentStatusLabel(doc.status)"
                        [severity]="getDocumentStatusSeverity(doc.status)"
                      ></p-tag>
                    </div>

                    <!-- Image du document -->
                    <div class="mb-3">
                      <img
                        [src]="doc.path"
                        [alt]="doc.documentType"
                        class="max-w-full md:max-w-md h-auto rounded-md border border-gray-300 cursor-pointer hover:opacity-90 transition-opacity"
                        (click)="openImage(doc.path)"
                      />
                    </div>

                    <p class="text-sm text-gray-500">
                      <i class="pi pi-calendar mr-1"></i>
                      Upload√© le
                      {{ doc.uploadedAt | date : "dd/MM/yyyy √† HH:mm" }}
                    </p>

                    <!-- Motif de refus -->
                    <div
                      *ngIf="doc.status === 'rejected' && doc.rejectionReason"
                      class="mt-3 p-3 bg-red-50 border border-red-200 rounded-md"
                    >
                      <p class="text-sm text-red-800">
                        <strong
                          ><i class="pi pi-exclamation-triangle mr-1"></i>Motif
                          du refus :</strong
                        >
                        {{ doc.rejectionReason }}
                      </p>
                    </div>
                  </div>

                  <!-- Actions -->
                  <div
                    class="flex md:flex-col gap-2 w-full md:w-auto"
                    *ngIf="doc.status === 'pending'"
                  >
                    <button
                      pButton
                      label="Valider"
                      icon="pi pi-check"
                      class="p-button-success p-button-sm flex-1 md:flex-none"
                      (click)="validateDocument(doc._id!)"
                    ></button>
                    <button
                      pButton
                      label="Rejeter"
                      icon="pi pi-times"
                      class="p-button-danger p-button-outlined p-button-sm flex-1 md:flex-none"
                      (click)="openRejectDialog(doc._id)"
                    ></button>
                  </div>
                </div>
              </div>

              <!-- Aucun document -->
              <div
                *ngIf="
                  !provider.verificationDocuments ||
                  provider.verificationDocuments.length === 0
                "
                class="text-center py-12 text-gray-500"
              >
                <i class="pi pi-file text-5xl mb-3 text-gray-300"></i>
                <p class="text-lg font-medium">Aucun document upload√©</p>
                <p class="text-sm text-gray-400 mt-1">
                  Le prestataire n'a pas encore t√©l√©charg√© de documents de
                  v√©rification
                </p>
              </div>
            </div>
          </p-tabPanel>

          <!-- üìä Statistiques -->
          <p-tabPanel header="Statistiques" leftIcon="pi pi-chart-line">
            <div class="p-6">
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div
                  class="text-center p-6 bg-blue-50 rounded-lg border border-blue-200"
                >
                  <i class="pi pi-briefcase text-3xl text-blue-600 mb-2"></i>
                  <p class="text-sm text-blue-600 mb-1">Missions</p>
                  <p class="text-3xl font-bold text-blue-700">
                    {{ provider.nombreMissions || 0 }}
                  </p>
                </div>
                <div
                  class="text-center p-6 bg-yellow-50 rounded-lg border border-yellow-200"
                >
                  <i class="pi pi-star text-3xl text-yellow-600 mb-2"></i>
                  <p class="text-sm text-yellow-600 mb-1">Note moyenne</p>
                  <p class="text-3xl font-bold text-yellow-700">
                    {{ provider.noteGenerale || 0 }}
                  </p>
                </div>
                <div
                  class="text-center p-6 bg-green-50 rounded-lg border border-green-200"
                >
                  <i class="pi pi-comment text-3xl text-green-600 mb-2"></i>
                  <p class="text-sm text-green-600 mb-1">Avis</p>
                  <p class="text-3xl font-bold text-green-700">
                    {{ provider.nombreAvis || 0 }}
                  </p>
                </div>
                <div
                  class="text-center p-6 bg-purple-50 rounded-lg border border-purple-200"
                >
                  <i class="pi pi-calendar text-3xl text-purple-600 mb-2"></i>
                  <p class="text-sm text-purple-600 mb-1">Inscription</p>
                  <p class="text-sm font-bold text-purple-700">
                    {{ provider.dateInscription | date : "dd/MM/yyyy" }}
                  </p>
                </div>
              </div>
            </div>
          </p-tabPanel>
        </p-tabView>
      </div>
    </div>
  </div>

  <!-- Dialog de rejet -->
  <p-dialog
    [(visible)]="showRejectDialog"
    [modal]="true"
    [style]="{ width: '500px' }"
    [draggable]="false"
    [resizable]="false"
    header="Motif du refus"
  >
    <div class="flex flex-column gap-3 py-3">
      <label for="motif" class="font-medium text-gray-700">
        Veuillez indiquer la raison du refus :
      </label>
      <textarea
        id="motif"
        [(ngModel)]="rejectMotif"
        rows="5"
        class="w-full"
        placeholder="Ex: Document illisible, informations non conformes, document expir√©..."
      ></textarea>
    </div>
    <ng-template pTemplate="footer">
      <button
        pButton
        label="Annuler"
        icon="pi pi-times"
        class="p-button-text"
        (click)="showRejectDialog = false"
      ></button>
      <button
        pButton
        label="Confirmer le refus"
        icon="pi pi-check"
        class="p-button-danger"
        (click)="confirmReject()"
      ></button>
    </ng-template>
  </p-dialog>

  <p-confirmDialog></p-confirmDialog>
  <p-toast position="top-right"></p-toast>
</div>
